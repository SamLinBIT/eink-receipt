<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµ·æ‹‰é²å¤§é¥­åº— - é«˜çº§æ‰“å•æœº</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --paper-width: 380px;
            --bg-color: #2b2b2b;
            --machine-color: #1a1a1a;
        }

        /* å¼•å…¥æ–¹æ­£å°æ ‡å®‹ç®€ä½“å­—ä½“ */
        @font-face {
            font-family: 'FZXBSJW';
            src: url('æ–¹æ­£å°æ ‡å®‹ç®€ä½“.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            background-color: var(--bg-color);
            color: #fff;
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- æ§åˆ¶é¢æ¿ --- */
        .controls {
            width: 100%;
            background: #333;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            border-bottom: 2px solid #444;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .control-group {
            display: flex;
            gap: 5px;
            align-items: center;
            border-right: 1px solid #555;
            padding: 0 10px;
        }

        button, label.btn-label {
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid #555;
            background: #444;
            color: #eee;
            border-radius: 4px;
        }

        button:hover { background: #555; }
        button.active { background: #e74c3c; color: white; border-color: #c0392b; }
        .export-btn { background: #27ae60 !important; border-color: #2ecc71 !important; }

        /* --- æ‰“å°åŒºåŸŸ --- */
        .printer-stage {
            flex-grow: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: var(--machine-color);
            padding: 40px 0;
            overflow-x: hidden;
        }

        /* æ”¶æ®æœ¬ä½“ */
        .receipt-container {
            background-color: #fff;
            width: var(--paper-width);
            color: #000;
            font-family: 'FZXBSJW', 'Courier New', 'SimSun', serif;
            padding: 30px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            background-image: linear-gradient(rgba(255,255,255,0.97), rgba(255,255,255,0.97)), url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIi8+CjxwYXRoIGQ9Ik0wIDBoNHY0SDB6IiBmaWxsPSIjMDAwIiBmaWxsLW9wYWNpdHk9IjAuMDUiLz4KPC9zdmc+');
        }

        /* æ¯”ä¾‹ */
        .ratio-2-3 { aspect-ratio: 2 / 3; }
        .ratio-3-5 { aspect-ratio: 3 / 5; }
        .ratio-9-21 { aspect-ratio: 9 / 21; }

        /* é”¯é½¿æ•ˆæœ */
        .jagged-edge {
            clip-path: polygon(
                0% 0%, 2% 1%, 4% 0%, 6% 1%, 8% 0%, 10% 1%, 12% 0%, 14% 1%, 16% 0%, 18% 1%, 20% 0%, 22% 1%, 24% 0%, 26% 1%, 28% 0%, 30% 1%, 32% 0%, 34% 1%, 36% 0%, 38% 1%, 40% 0%, 42% 1%, 44% 0%, 46% 1%, 48% 0%, 50% 1%, 52% 0%, 54% 1%, 56% 0%, 58% 1%, 60% 0%, 62% 1%, 64% 0%, 66% 1%, 68% 0%, 70% 1%, 72% 0%, 74% 1%, 76% 0%, 78% 1%, 80% 0%, 82% 1%, 84% 0%, 86% 1%, 88% 0%, 90% 1%, 92% 0%, 94% 1%, 96% 0%, 98% 1%, 100% 0%,
                100% 100%, 98% 99%, 96% 100%, 94% 99%, 92% 100%, 90% 99%, 88% 100%, 86% 99%, 84% 100%, 82% 99%, 80% 100%, 78% 99%, 76% 100%, 74% 99%, 72% 100%, 70% 99%, 68% 100%, 66% 99%, 64% 100%, 62% 99%, 60% 100%, 58% 99%, 56% 100%, 54% 99%, 52% 100%, 50% 99%, 48% 100%, 46% 99%, 44% 100%, 42% 99%, 40% 100%, 38% 99%, 36% 100%, 34% 99%, 32% 100%, 30% 99%, 28% 100%, 26% 99%, 24% 100%, 22% 99%, 20% 100%, 18% 99%, 16% 100%, 14% 99%, 12% 100%, 10% 99%, 8% 100%, 6% 99%, 4% 100%, 2% 99%, 0% 100%
            );
        }

        /* æ‹–æ‹½ç›¸å…³ */
        .barcode-wrapper {
            position: absolute;
            top: 110px;
            left: 200px;
            cursor: grab;
            user-select: none;
            mix-blend-mode: multiply;
            z-index: 10;
        }
        .barcode-wrapper:active { cursor: grabbing; }
        
        /* å›¾ç« æ ·å¼ - ä½œä¸ºç‹¬ç«‹æ¶‚å±‚ */
        .stamp-wrapper {
            position: absolute;
            top: 40px; /* è°ƒæ•´ä½ç½®ï¼Œä½¿å…¶åˆå§‹ä½ç½®åœ¨å°ç¥¨çš„å·¦ä¸Šè§’ */
            left: 200px;
            cursor: grab;
            user-select: none;
            mix-blend-mode: multiply;
            z-index: 1000; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            transform-origin: center;
            pointer-events: auto;
        }
        .stamp-wrapper:active { cursor: grabbing; }
        
        .dragging { opacity: 0.7; border: 1px dashed #666; }

        .delete-active .editable-item:hover { background: rgba(255,0,0,0.1); outline: 1px dashed red; cursor: pointer; }
        
        /* æ”¶æ®æ’ç‰ˆç»†èŠ‚ */
        .header { margin-bottom: 10px; }
        .order-num { font-size: 68px; font-weight: bold; line-height: 0.9; }
        .hotel-title { font-size: 20px; font-weight: bold; }
        .slip-type { font-size: 32px; font-weight: bold;}
        .divider { border-bottom: 2px dashed #000; margin: 1px 0; }
        .menu-item { display: flex; margin-bottom: 1px; align-items: baseline; font-weight: bold; }
        .item-name { font-size: 22px; font-weight: bold; }
        .item-desc { font-size: 15px; }
        .note { font-size: 16px; font-weight: bold; }
        .footer-note { font-size: 20px; font-weight: bold; margin-bottom: 15px; }
        .total-price { font-size: 22px; font-weight: bold; }

        @media (max-width: 450px) {
            .receipt-container { transform: scale(0.85); transform-origin: top center; }
            .controls { padding: 5px; gap: 4px; }
            .control-group { border: none; padding: 2px; }
        }
    </style>
</head>
<body>

    <div class="controls">
        <div class="control-group">
            <button onclick="setRatio('2-3')" id="btn-2-3" class="active">2:3</button>
            <button onclick="setRatio('3-5')" id="btn-3-5">3:5</button>
            <button onclick="setRatio('9-21')" id="btn-9-21">9:21</button>
        </div>
        <div class="control-group">
            <button onclick="toggleJagged()" id="btn-jag">âœ‚ï¸ é”¯é½¿:å¼€</button>
        </div>
        <div class="control-group">
            <button onclick="toggleDeleteMode()" id="btn-del">ğŸ—‘ï¸ åˆ é™¤</button>
            <button onclick="addMenuItem()" id="btn-add">ğŸ½ï¸ æˆ‘è¦åŠ èœ</button>
            <button onclick="calculateTotal()" id="btn-refresh">ğŸ”„ åˆ·æ–°ä»·æ ¼</button>
        </div>
        <div class="control-group">
            <label class="btn-label" for="font-upload">æ›´æ”¹å­—ä½“</label>
            <input type="file" id="font-upload" hidden onchange="loadCustomFont(this)">
            <button onclick="toggleStamp()" id="btn-stamp">ğŸ–‹ï¸ å›¾ç« :å…³</button>
            <label class="btn-label" for="stamp-upload">è‡ªå®šä¹‰å›¾ç« </label>
            <input type="file" id="stamp-upload" accept=".png" hidden onchange="loadCustomStamp(this)">
            <button onclick="exportImage()" class="export-btn">ğŸ“¸ å¯¼å‡ºå›¾ç‰‡</button>
        </div>
        <div class="control-group">
            <label style="font-size: 13px;">æ—‹è½¬æ¡å½¢ç :</label>
            <button onclick="rotateBarcode(-1)" style="font-size: 12px;">â†º -1Â°</button>
            <button onclick="rotateBarcode(1)" style="font-size: 12px;">â†» +1Â°</button>
            <button onclick="rotateBarcode(-10)" style="font-size: 12px;">â†º -10Â°</button>
            <button onclick="rotateBarcode(10)" style="font-size: 12px;">â†» +10Â°</button>
        </div>
        <div class="control-group">
            <label style="font-size: 13px;">æ—‹è½¬å›¾ç« :</label>
            <button onclick="rotateStamp(-1)" style="font-size: 12px;">â†º -1Â°</button>
            <button onclick="rotateStamp(1)" style="font-size: 12px;">â†» +1Â°</button>
            <button onclick="rotateStamp(-10)" style="font-size: 12px;">â†º -10Â°</button>
            <button onclick="rotateStamp(10)" style="font-size: 12px;">â†» +10Â°</button>
        </div>
    </div>

    <div class="printer-stage">
        <div class="receipt-container ratio-2-3 jagged-edge" id="receipt" contenteditable="true">
            
            <!-- å›¾ç« å…ƒç´  - ä½œä¸ºç‹¬ç«‹æ¶‚å±‚ -->
            <div class="stamp-wrapper" id="stamp-move" contenteditable="false" onmousedown="startDrag(event)" ontouchstart="startDrag(event)" ondblclick="resizeStamp()" style="display: none;">
                <img id="stamp" src="stamp.png" alt="Stamp" style="width: 100px; height: auto; cursor: grab; opacity: 0.8;">
            </div>
            
            <div class="barcode-wrapper" id="barcode-move" contenteditable="false" onmousedown="startDrag(event)" ontouchstart="startDrag(event)" ondblclick="editBarcode()">
                <svg id="barcode"></svg>
            </div>

            <div class="header editable-item">
                <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                    <div class="order-num">018</div>
                    <div style="text-align:right">
                        <div class="hotel-title">æµ·æ‹‰é²å¤§é¥­åº—</div>
                        <div class="slip-type">ç•™å°å•</div>
                    </div>
                </div>
                <div class="header-info" style="font-size:15px; margin-top:4px;">
                    Address: Hyrule Hotel<br>
                    Date: 2/14/2026 18:15<br>
                    Traveler: Link
                </div>
            </div>

            <div style="flex-grow:1;">
                <div class="menu-header" style="display:flex; font-size:16px; color:#181818; margin-bottom:3px;">
                    <div style="width:50px">æ•°é‡</div>
                    <div style="flex:1">èœå“</div>
                    <div>ä»·æ ¼</div>
                </div>
                <div class="divider"></div>
                <div id="item-list">
                    <div class="menu-item editable-item">
                        <div class="item-quantity" style="width:50px; font-size: 22px;">1</div>
                        <div style="flex:1">
                            <div class="item-name">ç•ªèŒ„æ±¤ğŸ²</div>
                            <div class="item-desc">æµ·æ‹‰é²ç•ªèŒ„/é²œå¥¶/å²©ç›</div>
                        </div>
                        <div class="item-price" style="font-weight:bold; font-size: 22px;">29.8</div>
                    </div>
                    <div class="menu-item editable-item">
                        <div class="item-quantity" style="width:50px; font-size: 22px;">1</div>
                        <div style="flex:1">
                            <div class="item-name">èŸ¹è‚‰è›‹ç‚’é¥­ğŸ›</div>
                            <div class="item-desc">èƒèŸ¹/æµ·æ‹‰é²ç±³/ç¦½è›‹/å²©ç›</div>
                        </div>
                        <div class="item-price" style="font-weight:bold; font-size: 22px;">69.8</div>
                    </div>
                    <div class="menu-item editable-item">
                        <div class="item-quantity" style="width:50px; font-size: 22px;">4</div>
                        <div style="flex:1">
                            <div class="item-name">çƒ¤è‚‰è˜‘è‡ä¸²ğŸ¢</div>
                            <div class="item-desc">è˜‘è‡/å…½è‚‰</div>
                        </div>
                        <div class="item-price" style="font-weight:bold; font-size: 22px;">8.8</div>
                    </div>
                    <div class="menu-item editable-item">
                        <div class="item-quantity" style="width:50px; font-size: 22px;">2</div>
                        <div style="flex:1">
                            <div class="item-name">é»„æ²¹è‹¹æœğŸ</div>
                            <div class="item-desc">è‹¹æœ/å±±ç¾Šé»„æ²¹</div>
                        </div>
                        <div class="item-price" style="font-weight:bold; font-size: 22px;">16.8</div>
                    </div>
                    <div class="menu-item editable-item">
                        <div class="item-quantity" style="width:50px; font-size: 22px;">2</div>
                        <div style="flex:1">
                            <div class="item-name">é²œè›‹å¸ƒä¸ğŸ®</div>
                            <div class="item-desc">ç¦½è›‹/é²œå¥¶/è”—ç³–</div>
                        </div>
                        <div class="item-price" style="font-weight:bold; font-size: 22px;">19.8</div>
                    </div>
                </div>
                <div class="divider"></div>
            </div>

            <div class="note editable-item">
                <div class="note">æ•´å•å¤‡æ³¨ï¼š<br>ä¸è¦æ€ªç‰©ç²¾å è°¢è°¢</div>
            </div>
            <div class="footer editable-item">
                <div style="display:flex; justify-content:space-between; align-items: flex-end;">
                    <div style="font-size:13px">åº§ä½: åˆå§‹å°åœ°</div>
                    <div style="text-align:right">
                        <div class="total-price" id="total-price">åˆè®¡: 0 å¢æ¯”</div>
                        <div id="discount">æŠ˜æ‰£æƒ…å†µ: -14 å¢æ¯”</div>
                        <div style="font-size:16px; font-weight:bold" id="final-price">å®ä»˜: 0 å¢æ¯”</div>
                    </div>
                </div>
                <div style="text-align:center; font-size:11px; margin-top:15px; border-top:1px solid #000; padding-top:10px;">
                    --ç¥å‹‡è€…æ—…é€”æ„‰å¿«ï¼å‘€å“ˆå“ˆğŸƒ--
                </div>
            </div>
        </div>
    </div>

    <!-- æ ·å¼è°ƒæ•´é¢æ¿ -->
    <div class="controls" style="top: auto; bottom: 0; border-bottom: none; border-top: 2px solid #444; transition: all 0.3s ease;">
        <div class="control-group" style="border-right: none;">
            <button onclick="toggleStylePanel()" id="btn-toggle-panel" style="font-size: 12px; padding: 4px 8px;">â–² éšè—é¢æ¿</button>
        </div>
        <div class="control-group" id="style-controls">
            <label style="font-size: 13px;">èœå•é¡¹é—´è·:</label>
            <input type="range" min="1" max="20" value="2" oninput="adjustMenuItemSpacing(this.value)" style="width: 80px;">
            <span id="menu-item-spacing-value">2px</span>
        </div>
        <div class="control-group" id="style-controls">
            <label style="font-size: 13px;">èœå“åç§°å¤§å°:</label>
            <input type="range" min="14" max="30" value="22" oninput="adjustItemNameSize(this.value)" style="width: 80px;">
            <span id="item-name-size-value">22px</span>
        </div>
        <div class="control-group" id="style-controls">
            <label style="font-size: 13px;">èœå“æè¿°å¤§å°:</label>
            <input type="range" min="10" max="20" value="15" oninput="adjustItemDescSize(this.value)" style="width: 80px;">
            <span id="item-desc-size-value">15px</span>
        </div>
        <div class="control-group" id="style-controls">
            <label style="font-size: 13px;">è®¢å•å·å¤§å°:</label>
            <input type="range" min="30" max="70" value="68" oninput="adjustOrderNumSize(this.value)" style="width: 80px;">
            <span id="order-num-size-value">68px</span>
        </div>
        <div class="control-group" id="style-controls">
            <label style="font-size: 13px;">å¤´éƒ¨ä¿¡æ¯å¤§å°:</label>
            <input type="range" min="10" max="20" value="15" oninput="adjustHeaderInfoSize(this.value)" style="width: 80px;">
            <span id="header-info-size-value">15px</span>
        </div>
        <div class="control-group" id="style-controls">
            <label style="font-size: 13px;">èœå•è¡¨å¤´å¤§å°:</label>
            <input type="range" min="12" max="22" value="16" oninput="adjustMenuHeaderSize(this.value)" style="width: 80px;">
            <span id="menu-header-size-value">16px</span>
        </div>
    </div>

    <script>
        // é¢æ¿åˆ‡æ¢å‡½æ•°
        let stylePanelVisible = true;
        function toggleStylePanel() {
            const controls = document.querySelectorAll('#style-controls');
            const btn = document.getElementById('btn-toggle-panel');
            const panel = document.querySelector('.controls');
            
            stylePanelVisible = !stylePanelVisible;
            
            if (stylePanelVisible) {
                // æ˜¾ç¤ºé¢æ¿
                controls.forEach(control => {
                    control.style.display = 'flex';
                });
                btn.innerText = 'â–¼ éšè—é¢æ¿';
                panel.style.padding = '10px';
            } else {
                // éšè—é¢æ¿
                controls.forEach(control => {
                    control.style.display = 'none';
                });
                btn.innerText = 'â–² æ˜¾ç¤ºé¢æ¿';
                panel.style.padding = '5px';
            }
        }
        
        // æ ·å¼è°ƒæ•´å‡½æ•°
        function adjustMenuItemSpacing(value) {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.style.marginBottom = value + 'px';
            });
            document.getElementById('menu-item-spacing-value').textContent = value + 'px';
        }
        
        function adjustItemNameSize(value) {
            // è°ƒæ•´èœå“åç§°å¤§å°
            document.querySelectorAll('.item-name').forEach(item => {
                item.style.fontSize = value + 'px';
            });
            // åŒæ­¥è°ƒæ•´æ•°é‡å¤§å°
            document.querySelectorAll('.item-quantity').forEach(item => {
                item.style.fontSize = value + 'px';
            });
            // åŒæ­¥è°ƒæ•´ä»·æ ¼å¤§å°
            document.querySelectorAll('.item-price').forEach(item => {
                item.style.fontSize = value + 'px';
            });
            document.getElementById('item-name-size-value').textContent = value + 'px';
        }
        
        function adjustItemDescSize(value) {
            document.querySelectorAll('.item-desc').forEach(item => {
                item.style.fontSize = value + 'px';
            });
            document.getElementById('item-desc-size-value').textContent = value + 'px';
        }
        
        function adjustOrderNumSize(value) {
            document.querySelectorAll('.order-num').forEach(item => {
                item.style.fontSize = value + 'px';
            });
            document.getElementById('order-num-size-value').textContent = value + 'px';
        }
        
        function adjustHeaderInfoSize(value) {
            document.querySelectorAll('.header-info').forEach(item => {
                item.style.fontSize = value + 'px';
            });
            document.getElementById('header-info-size-value').textContent = value + 'px';
        }
        
        function adjustMenuHeaderSize(value) {
            document.querySelectorAll('.menu-header').forEach(item => {
                item.style.fontSize = value + 'px';
            });
            document.getElementById('menu-header-size-value').textContent = value + 'px';
        }
        
        // 1. é”¯é½¿åˆ‡æ¢
        function toggleJagged() {
            const r = document.getElementById('receipt');
            const btn = document.getElementById('btn-jag');
            const isOn = r.classList.toggle('jagged-edge');
            btn.innerText = isOn ? "âœ‚ï¸ é”¯é½¿:å¼€" : "âœ‚ï¸ é”¯é½¿:å…³";
        }

        // 2. æ¯”ä¾‹åˆ‡æ¢
        function setRatio(c) {
            const r = document.getElementById('receipt');
            r.classList.remove('ratio-2-3', 'ratio-3-5', 'ratio-9-21');
            r.classList.add('ratio-' + c);
            document.querySelectorAll('.control-group button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + c).classList.add('active');
        }

        // 3. æ‹–æ‹½åŠŸèƒ½ï¼ˆæ”¯æŒæ¡å½¢ç å’Œå›¾ç« ï¼‰
        let dragItem = null;
        let active = false;
        let currentX, currentY, initialX, initialY;
        let xOffset = 0, yOffset = 0;

        function startDrag(e) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡å’Œé»˜è®¤è¡Œä¸ºï¼Œé˜²æ­¢å›¾ç« è¢«æ’å…¥åˆ°æ–‡æœ¬ä¸­
            e.preventDefault();
            e.stopPropagation();
            
            const event = e.type === 'touchstart' ? e.touches[0] : e;
            initialX = event.clientX - xOffset;
            initialY = event.clientY - yOffset;
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æ¡å½¢ç æˆ–å›¾ç« 
            const barcodeMove = e.target.closest('#barcode-move');
            const stampMove = e.target.closest('#stamp-move');
            
            if (barcodeMove) {
                dragItem = barcodeMove;
                active = true;
            } else if (stampMove) {
                dragItem = stampMove;
                active = true;
            }
        }

        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('mouseup', () => {
            active = false;
            dragItem = null;
        });
        document.addEventListener('touchend', () => {
            active = false;
            dragItem = null;
        });

        function drag(e) {
            if (!active || !dragItem) return;
            e.preventDefault();
            const event = e.type === 'touchmove' ? e.touches[0] : e;
            currentX = event.clientX - initialX;
            currentY = event.clientY - initialY;
            xOffset = currentX;
            yOffset = currentY;
            
            // æ‹–æ‹½æ—¶ä¿æŒå½“å‰å…ƒç´ çš„æ—‹è½¬è§’åº¦
            if (dragItem.id === 'barcode-move') {
                dragItem.style.transform = `translate3d(${currentX}px, ${currentY}px, 0) rotate(${barcodeRotation}deg)`;
            } else if (dragItem.id === 'stamp-move') {
                dragItem.style.transform = `translate3d(${currentX}px, ${currentY}px, 0) rotate(${stampRotation}deg)`;
            }
        }

        // 4. åˆ é™¤æ¨¡å¼
        let delMode = false;
        function toggleDeleteMode() {
            delMode = !delMode;
            document.getElementById('receipt').classList.toggle('delete-active');
            document.getElementById('btn-del').classList.toggle('active');
            document.getElementById('receipt').setAttribute('contenteditable', delMode ? 'false' : 'true');
        }

        document.getElementById('receipt').addEventListener('click', (e) => {
            // é¦–å…ˆæ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯æ¡å½¢ç æˆ–å›¾ç« å…ƒç´ 
            const isBarcode = e.target.closest('#barcode-move');
            const isStamp = e.target.closest('#stamp-move');
            
            if (isBarcode || isStamp) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æ¡å½¢ç æˆ–å›¾ç« ï¼Œç«‹å³è¿”å›ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
                return;
            }
            
            // åªæœ‰åœ¨åˆ é™¤æ¨¡å¼ä¸”ä¸æ˜¯ç‚¹å‡»æ¡å½¢ç æˆ–å›¾ç« æ—¶æ‰ç»§ç»­
            if (!delMode) return;
            
            // åªæœ‰ç‚¹å‡»çš„æ˜¯å¯ç¼–è¾‘é¡¹æ—¶æ‰åˆ é™¤
            const target = e.target.closest('.editable-item');
            if (target) {
                target.remove();
                calculateTotal();
            }
        });

        document.getElementById('item-list').addEventListener('input', calculateTotal);
        document.getElementById('discount').addEventListener('input', calculateTotal);

        // 5. å¯¼å‡ºå›¾ç‰‡
        function exportImage() {
            const receipt = document.getElementById('receipt');
            const btn = document.querySelector('.export-btn');
            const stamp = document.getElementById('stamp-move');
            const barcode = document.getElementById('barcode-move');
            
            if (!receipt) {
                alert('é”™è¯¯: æ”¶æ®å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            if (typeof html2canvas === 'undefined') {
                alert('é”™è¯¯: html2canvas åº“æœªåŠ è½½');
                return;
            }
            
            const originalBtnText = btn.innerText;
            const stampWasVisible = stamp && stamp.style.display !== 'none';
            const barcodeWasVisible = barcode && barcode.style.display !== 'none';
            
            btn.innerText = "ç”Ÿæˆä¸­...";
            btn.disabled = true;
            
            setTimeout(async () => {
                try {
                    // ç¬¬ä¸€æ­¥ï¼šåœ¨æ˜¾ç¤ºçŠ¶æ€ä¸‹è·å–æ‰€æœ‰å…ƒç´ çš„ä½ç½®å’Œå°ºå¯¸
                    let barcodeInfo = null;
                    let stampInfo = null;
                    let stampImgSrc = null;
                    
                    if (barcode && barcodeWasVisible) {
                        const barcodeRect = barcode.getBoundingClientRect();
                        const receiptRect = receipt.getBoundingClientRect();
                        barcodeInfo = {
                            x: barcodeRect.left - receiptRect.left,
                            y: barcodeRect.top - receiptRect.top,
                            width: barcodeRect.width,
                            height: barcodeRect.height
                        };
                    }
                    
                    if (stamp && stampWasVisible) {
                        const stampRect = stamp.getBoundingClientRect();
                        const receiptRect = receipt.getBoundingClientRect();
                        const stampImg = document.getElementById('stamp');
                        stampInfo = {
                            x: stampRect.left - receiptRect.left,
                            y: stampRect.top - receiptRect.top,
                            width: stampRect.width,
                            height: stampRect.height
                        };
                        if (stampImg) {
                            stampImgSrc = stampImg.src;
                        }
                    }
                    
                    // ç¬¬äºŒæ­¥ï¼šä¸´æ—¶éšè—å¯èƒ½å¯¼è‡´è·¨åŸŸé—®é¢˜çš„å…ƒç´ 
                    if (stamp) stamp.style.display = 'none';
                    if (barcode) barcode.style.display = 'none';
                    
                    // ç¬¬ä¸‰æ­¥ï¼šæ•è·å¹²å‡€çš„æ”¶æ®ï¼ˆä¸å«å›¾ç« å’Œæ¡å½¢ç ï¼‰
                    const receiptCanvas = await html2canvas(receipt, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        useCORS: false,
                        allowTaint: false
                    });

                    if (!receiptCanvas || !(receiptCanvas instanceof HTMLCanvasElement)) {
                        throw new Error('Canvas åˆ›å»ºå¤±è´¥');
                    }

                    // ç¬¬å››æ­¥ï¼šæ¢å¤æ˜¾ç¤º
                    if (barcode && barcodeWasVisible) barcode.style.display = 'block';
                    if (stamp && stampWasVisible) stamp.style.display = 'block';
                    
                    // ç¬¬äº”æ­¥ï¼šåˆ›å»ºæœ€ç»ˆç”»å¸ƒ
                    const finalCanvas = document.createElement('canvas');
                    finalCanvas.width = receiptCanvas.width;
                    finalCanvas.height = receiptCanvas.height;
                    const ctx = finalCanvas.getContext('2d');
                    
                    // å…ˆç»˜åˆ¶æ”¶æ®
                    ctx.drawImage(receiptCanvas, 0, 0);
                    
                    // ç»˜åˆ¶æ¡å½¢ç  - ç”¨html2canvasæ•è·
                    if (barcode && barcodeWasVisible && barcodeInfo) {
                        const barcodeCanvas = await html2canvas(barcode, {
                            backgroundColor: null,
                            scale: 2,
                            useCORS: false,
                            allowTaint: false
                        });
                        
                        ctx.drawImage(
                            barcodeCanvas, 
                            barcodeInfo.x * 2, 
                            barcodeInfo.y * 2, 
                            barcodeInfo.width * 2, 
                            barcodeInfo.height * 2
                        );
                    }
                    
                    // ç»˜åˆ¶å›¾ç«  - ç›´æ¥ä½¿ç”¨Imageå¯¹è±¡ç»˜åˆ¶ï¼Œç»å¯¹é¿å…canvasæ±¡æŸ“
                    if (stamp && stampWasVisible && stampInfo && stampImgSrc) {
                        const img = new Image();
                        
                        await new Promise((resolve, reject) => {
                            img.onload = () => {
                                ctx.globalAlpha = 0.8;
                                ctx.drawImage(
                                    img, 
                                    stampInfo.x * 2, 
                                    stampInfo.y * 2, 
                                    stampInfo.width * 2, 
                                    stampInfo.height * 2
                                );
                                ctx.globalAlpha = 1.0;
                                resolve();
                            };
                            img.onerror = reject;
                            img.src = stampImgSrc;
                        });
                    }

                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    link.download = `Hyrule_Receipt_${Date.now()}.png`;
                    link.href = finalCanvas.toDataURL('image/png');
                    link.click();
                    
                    setTimeout(() => {
                        alert('å¯¼å‡ºæˆåŠŸï¼');
                    }, 500);
                } catch (error) {
                    console.error('å¯¼å‡ºå¤±è´¥:', error);
                    alert('å¯¼å‡ºå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åå†è¯•'));
                } finally {
                    // ç¡®ä¿æ¢å¤æ‰€æœ‰çŠ¶æ€
                    btn.innerText = originalBtnText;
                    btn.disabled = false;
                    if (stamp && stampWasVisible && stamp.style.display === 'none') {
                        stamp.style.display = 'block';
                    }
                    if (barcode && barcodeWasVisible && barcode.style.display === 'none') {
                        barcode.style.display = 'block';
                    }
                }
            }, 100);
        }

        // åŠ è½½å­—ä½“
        function loadCustomFont(input) {
            if (input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const font = new FontFace('UserFont', `url(${e.target.result})`);
                    font.load().then(f => {
                        document.fonts.add(f);
                        document.getElementById('receipt').style.fontFamily = "'UserFont', sans-serif";
                    });
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // åˆå§‹åŒ–
        window.onload = () => {
            JsBarcode("#barcode", "H20260214018", { width: 0.8, height: 20, displayValue: true, fontSize: 10, background: null });
            calculateTotal();
            
            // ä¸ºæ¡å½¢ç å…ƒç´ æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢ç‚¹å‡»æ—¶è§¦å‘åˆ é™¤æ¨¡å¼
            const barcodeMove = document.getElementById('barcode-move');
            if (barcodeMove) {
                barcodeMove.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
                barcodeMove.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                });
            }
            
            // ä¸ºå›¾ç« å…ƒç´ æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢ç‚¹å‡»æ—¶è§¦å‘åˆ é™¤æ¨¡å¼
            const stampMove = document.getElementById('stamp-move');
            if (stampMove) {
                stampMove.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
                stampMove.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                });
            }
        };

        // åŠ èœåŠŸèƒ½
        function addMenuItem() {
            const itemList = document.getElementById('item-list');
            const newItem = document.createElement('div');
            newItem.className = 'menu-item editable-item';
            // è·å–å½“å‰çš„èœå“åç§°å­—ä½“å¤§å°ï¼Œç¡®ä¿æ–°æ·»åŠ çš„èœå•é¡¹ä½¿ç”¨ç›¸åŒçš„å¤§å°
            const currentSize = document.querySelector('.item-name').style.fontSize || '22px';
            newItem.innerHTML = `
                <div class="item-quantity" style="width:50px; font-size: ${currentSize};">1</div>
                <div style="flex:1">
                    <div class="item-name" style="font-size: ${currentSize};">æ–°èœå“</div>
                    <div class="item-desc">ç‚¹å‡»ç¼–è¾‘æè¿°</div>
                </div>
                <div class="item-price" style="font-weight:bold; font-size: ${currentSize};">0.0</div>
            `;
            itemList.appendChild(newItem);
            calculateTotal();
        }

        // ç¼–è¾‘æ¡å½¢ç 
        let currentBarcodeValue = '20260214018';
        let barcodeRotation = 0;
        let stampRotation = 0;
        
        function editBarcode() {
            const newValue = prompt('è¯·è¾“å…¥æ¡å½¢ç å†…å®¹:', currentBarcodeValue);
            if (newValue && newValue.trim()) {
                currentBarcodeValue = newValue.trim();
                JsBarcode("#barcode", currentBarcodeValue, { width: 0.8, height: 20, displayValue: true, fontSize: 10, background: null });
                // ä¿æŒæ¡å½¢ç çš„æ—‹è½¬è§’åº¦
                updateBarcodeRotation();
            }
        }
        
        // æ›´æ–°æ¡å½¢ç çš„æ—‹è½¬
        function updateBarcodeRotation() {
            const barcodeMove = document.getElementById('barcode-move');
            if (barcodeMove) {
                const transform = barcodeMove.style.transform || '';
                // æå–ç°æœ‰çš„ translate å€¼
                const translateMatch = transform.match(/translate3d\(([^)]+)\)/);
                const translate = translateMatch ? `translate3d(${translateMatch[1]})` : '';
                barcodeMove.style.transform = `${translate} rotate(${barcodeRotation}deg)`;
            }
        }
        
        // æ›´æ–°å›¾ç« çš„æ—‹è½¬
        function updateStampRotation() {
            const stampMove = document.getElementById('stamp-move');
            if (stampMove) {
                const transform = stampMove.style.transform || '';
                // æå–ç°æœ‰çš„ translate å€¼
                const translateMatch = transform.match(/translate3d\(([^)]+)\)/);
                const translate = translateMatch ? `translate3d(${translateMatch[1]})` : '';
                stampMove.style.transform = `${translate} rotate(${stampRotation}deg)`;
            }
        }
        
        // æ—‹è½¬æ¡å½¢ç 
        function rotateBarcode(degrees) {
            barcodeRotation = (barcodeRotation + degrees) % 360;
            updateBarcodeRotation();
        }
        
        // æ—‹è½¬å›¾ç« 
        function rotateStamp(degrees) {
            stampRotation = (stampRotation + degrees) % 360;
            updateStampRotation();
        }
        
        // å›¾ç« åŠŸèƒ½
        let stampVisible = false;
        function toggleStamp() {
            const stamp = document.getElementById('stamp-move');
            const btn = document.getElementById('btn-stamp');
            stampVisible = !stampVisible;
            stamp.style.display = stampVisible ? 'block' : 'none';
            btn.innerText = stampVisible ? "ğŸ–‹ï¸ å›¾ç« :å¼€" : "ğŸ–‹ï¸ å›¾ç« :å…³";
            btn.classList.toggle('active', stampVisible);
        }
        
        // ä¸Šä¼ è‡ªå®šä¹‰å›¾ç« 
        function loadCustomStamp(input) {
            if (input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const stampImg = document.getElementById('stamp');
                    stampImg.src = e.target.result;
                    // å¦‚æœå›¾ç« å½“å‰æ˜¯éšè—çš„ï¼Œè‡ªåŠ¨æ˜¾ç¤ºå®ƒ
                    if (!stampVisible) {
                        toggleStamp();
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // è°ƒæ•´å›¾ç« å¤§å°
        function resizeStamp() {
            const stampImg = document.getElementById('stamp');
            const currentWidth = parseInt(stampImg.style.width) || 80;
            const newWidth = prompt('è¯·è¾“å…¥å›¾ç« å¤§å° (10-300px):', currentWidth);
            const width = parseInt(newWidth);
            if (!isNaN(width) && width >= 10 && width <= 300) {
                stampImg.style.width = width + 'px';
            }
        }

        // è®¡ç®—åˆè®¡
        function calculateTotal() {
            const items = document.querySelectorAll('#item-list .menu-item');
            let total = 0;
            items.forEach(item => {
                const qty = parseFloat(item.children[0].textContent) || 0;
                const price = parseFloat(item.children[2].textContent) || 0;
                total += qty * price;
            });
            document.getElementById('total-price').textContent = `åˆè®¡: ${total.toFixed(1)} å¢æ¯”`;
            
            const discountText = document.getElementById('discount').textContent;
            const discountMatch = discountText.match(/-?[\d.]+/);
            const discount = discountMatch ? parseFloat(discountMatch[0]) : 0;
            const finalPrice = total + discount;
            document.getElementById('final-price').textContent = `å®ä»˜: ${finalPrice.toFixed(1)}`;
        }
    </script>
</body>
</html>